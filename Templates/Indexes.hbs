// <auto-generated>
//     This code was generated with love by Gentitas.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

using Entitas;
using System.Collections.Generic;

{{#each this}}
namespace {{@key}}.Indexes {
	{{#each contexts}}
	namespace {{toUpper name}} {
		{{#each indexes}}
        public interface I{{toUpper name}}Index {
            /// Value: {{valueComponentName}} {{#if flagComponentNames}}| Flags:{{/if}} {{#each flagComponentNames}}{{toUpper this}}{{/each}}
            {{toUpper ../name}}Entity FindSingle({{type}} value);
            /// Value: {{valueComponentName}} {{#if flagComponentNames}}| Flags:{{/if}} {{#each flagComponentNames}}{{toUpper this}}{{/each}}
            HashSet<{{toUpper ../name}}Entity> Find({{type}} value);
        }

        public class {{toUpper name}}Index : Gentitas.Index<{{type}}, {{toUpper ../name}}Entity>, I{{toUpper name}}Index
        {
            IGroup<{{toUpper ../name}}Entity> groupToWatch;

            public {{toUpper name}}Index(StateContext context) : base()
            {
                groupToWatch = context.GetGroup(Matcher<{{toUpper ../name}}Entity>.AllOf({{toUpper ../name}}Matcher.{{valueComponentName}}{{#each flagComponentNames}}, {{toUpper ../../name}}Matcher.{{this}}{{/each}}));
                groupToWatch.OnEntityAdded += Added;
                groupToWatch.OnEntityUpdated += Updated;
                groupToWatch.OnEntityRemoved += Removed;
            }

            ~{{toUpper name}}Index () {
                groupToWatch.OnEntityAdded -= Added;
                groupToWatch.OnEntityUpdated -= Updated;
                groupToWatch.OnEntityRemoved -= Removed;
            }

            protected override bool Filter({{toUpper ../name}}Entity entity)
            {
                return entity.Has{{toUpper valueComponentName}}() {{#each flagComponentNames}}&& entity.Has{{this}}(){{/each}};
            }

            void HandleEntity({{toUpper ../name}}Entity entity)
            {
                var value = entity.{{toLower valueComponentName}};

                if (Filter(entity))
                {
                    if (!lookup.ContainsKey(value)) lookup.Add(value, new HashSet<{{toUpper ../name}}Entity>());
                    var list = lookup[value];
                    if (!list.Contains(entity)) list.Add(entity);
                }
                else
                {
                    if (lookup.ContainsKey(value))
                    {
                        var list = lookup[value];
                        if (list.Contains(entity)) list.Remove(entity);
                    }
                }
            }

            void HandleEntity({{toUpper ../name}}Entity entity, {{type}} previous{{toUpper name}})
            {
                if (entity.{{toLower valueComponentName}} != previous{{toUpper name}} && lookup.ContainsKey(previous{{toUpper name}}))
                {
                    var list = lookup[previous{{toUpper name}}];
                    if (list.Contains(entity)) list.Remove(entity);
                }

                HandleEntity(entity);
            }

            void Added(IGroup<{{toUpper ../name}}Entity> group, {{toUpper ../name}}Entity entity, int index, IComponent component)
            {
                HandleEntity(entity);
            }

            void Updated(IGroup<{{toUpper ../name}}Entity> group, {{toUpper ../name}}Entity entity, int index, IComponent previousComponent, IComponent component)
            {
                HandleEntity(entity, ((Components.{{toUpper ../name}}.{{toUpper valueComponentName}})previousComponent).value);
            }

            void Removed(IGroup<{{toUpper ../name}}Entity> group, {{toUpper ../name}}Entity entity, int index, IComponent component)
            {
                HandleEntity(entity);
            }

            public {{toUpper ../name}}Entity FindSingle({{type}} value)
            {
                if (!lookup.ContainsKey(value)) return null;
                return lookup[value].SingleEntity<{{toUpper ../name}}Entity>();
            }

            public HashSet<{{toUpper ../name}}Entity> Find({{type}} value)
            {
                if (!lookup.ContainsKey(value)) return null;
                return lookup[value];
            }
        }
		{{/each}}
	}
	{{/each}}
}
{{/each}}
